import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Expo

<Prerequisites>  
  - **Expo SQLite** - ä¸€ä¸ªæä¾›é€šè¿‡ SQLite API æŸ¥è¯¢æ•°æ®åº“è®¿é—®çš„åº“ - [ç‚¹å‡»äº†è§£æ›´å¤š](https://docs.expo.dev/versions/latest/sdk/sqlite/)
</Prerequisites>


#### æ­¥éª¤ 1 - ä» Expo æ¨¡æ¿è®¾ç½®é¡¹ç›®
<Npx>
create expo-app --template blank-typescript
</Npx>

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.expo.dev/more/create-expo/#create-a-new-project)äº†è§£æ›´å¤šå…³äºæ­¤æ¨¡æ¿çš„ä¿¡æ¯ã€‚

#### åŸºæœ¬æ–‡ä»¶ç»“æ„

å®‰è£…æ¨¡æ¿å¹¶æ·»åŠ  `db` æ–‡ä»¶å¤¹åï¼Œæ‚¨ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼šåœ¨ `db/schema.ts` æ–‡ä»¶ä¸­åŒ…å« drizzle è¡¨å®šä¹‰ã€‚`drizzle` æ–‡ä»¶å¤¹åŒ…å« SQL è¿ç§»æ–‡ä»¶å’Œå¿«ç…§

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ assets
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ db
 â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“œ .gitignore
 â”œ ğŸ“œ .npmrc
 â”œ ğŸ“œ app.json
 â”œ ğŸ“œ App.tsx
 â”œ ğŸ“œ babel.config.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### æ­¥éª¤ 2 - å®‰è£… expo-sqlite åŒ…
<Npx>
expo install expo-sqlite
</Npx>

#### æ­¥éª¤ 3 - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm
  -D drizzle-kit
</Npm>

#### æ­¥éª¤ 4 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `App.tsx` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```ts
import * as SQLite from 'expo-sqlite';
import { drizzle } from 'drizzle-orm/expo-sqlite';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);
```

#### æ­¥éª¤ 4 - åˆ›å»ºè¡¨

åœ¨ `db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable("users_table", {
  id: int().primaryKey({ autoIncrement: true }),
  name: text().notNull(),
  age: int().notNull(),
  email: text().notNull().unique(),
});
```

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†æ‰€æœ‰å…³äºæ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'sqlite',
  driver: 'expo',
  schema: './db/schema.ts',
  out: './drizzle',
});
```

#### æ­¥éª¤ 6 - è®¾ç½® `metro` é…ç½®

åœ¨æ ¹æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª `metro.config.js` æ–‡ä»¶å¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```js copy filename="metro.config.js"
const { getDefaultConfig } = require('expo/metro-config');
/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

#### æ­¥éª¤ 7 - æ›´æ–° `babel` é…ç½®
```js copy filename="babel.config.js"
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [["inline-import", { "extensions": [".sql"] }]] // <-- æ·»åŠ è¿™è¡Œ
  };
};
```

#### æ­¥éª¤ 8 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

åœ¨ Expo ä¸­ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶ååœ¨è¿è¡Œæ—¶ä½¿ç”¨ `drizzle-orm` çš„ `migrate()` å‡½æ•°åº”ç”¨å®ƒä»¬

ç”Ÿæˆè¿ç§»ï¼š
```bash copy
npx drizzle-kit generate
```

#### æ­¥éª¤ 9 - åº”ç”¨è¿ç§»å¹¶æŸ¥è¯¢æ•°æ®åº“ï¼š

è®©æˆ‘ä»¬ç”¨è¿ç§»å’ŒæŸ¥è¯¢æ¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤ç”¨æˆ·ï¼Œæ›´æ–° **App.tsx** æ–‡ä»¶

```ts copy
import { Text, View } from 'react-native';
import * as SQLite from 'expo-sqlite';
import { useEffect, useState } from 'react';
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { usersTable } from './db/schema';
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import migrations from './drizzle/migrations';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);

export default function App() {
  const { success, error } = useMigrations(db, migrations);
  const [items, setItems] = useState<typeof usersTable.$inferSelect[] | null>(null);

  useEffect(() => {
    if (!success) return;

    (async () => {
      await db.delete(usersTable);

      await db.insert(usersTable).values([
        {
            name: 'John',
            age: 30,
            email: 'john@example.com',
        },
      ]);

      const users = await db.select().from(usersTable);
      setItems(users);
    })();
  }, [success]);

  if (error) {
    return (
      <View>
        <Text>è¿ç§»é”™è¯¯ï¼š{error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>è¿ç§»æ­£åœ¨è¿›è¡Œä¸­...</Text>
      </View>
    );
  }

  if (items === null || items.length === 0) {
    return (
      <View>
        <Text>ç©º</Text>
      </View>
    );
  }

  return (
    <View
      style={{
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        width: '100%',
        height: '100%',
        justifyContent: 'center',
      }}
    >
      {items.map((item) => (
        <Text key={item.id}>{item.email}</Text>
      ))}
    </View>
  );
}
```

#### æ­¥éª¤ 10 - é¢„æ„å»ºå¹¶è¿è¡Œ expo åº”ç”¨

<CodeTabs items={['npm', 'yarn', 'pnpm', 'bun']}>
```bash copy
npx expo run:ios
```
```bash copy
yarn expo run:ios
```
```bash copy
pnpm expo run:ios
```
```bash copy
bun expo run:ios
```
</CodeTabs>
