---
title: "ä» TypeORM è¿ç§»åˆ° Drizzle"
---
import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";

## å…¥é—¨

æœ¬æŒ‡å—æä¾›äº†ä¸€ä¸ªå°†åŸºæœ¬çš„ **TypeORM** é¡¹ç›®è¿ç§»åˆ° **Drizzle ORM** çš„ç›´æ¥æ–¹æ³•ã€‚è™½ç„¶ç¤ºä¾‹ä¸»è¦å…³æ³¨ `PostgreSQL`ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹å¯¹å…¶ä»–æ”¯æŒçš„æ•°æ®åº“ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚

### è¿ç§»è¿‡ç¨‹æ¦‚è¿°

æ— è®ºä½ çš„åº”ç”¨ç±»å‹æˆ– API å±‚å¦‚ä½•ï¼Œä» **TypeORM** è¿ç§»åˆ° **Drizzle ORM** çš„æ­¥éª¤éƒ½ä¿æŒä¸€è‡´ï¼š

1. å®‰è£… **Drizzle ORM** å’Œ **Drizzle Kit**
2. è®¾ç½® **Drizzle config** æ–‡ä»¶
3. æ£€æŸ¥ä½ çš„æ•°æ®åº“
4. å°† **Drizzle ORM** è¿æ¥åˆ°ä½ çš„æ•°æ®åº“
5. å°†ä½ çš„ **TypeORM** æŸ¥è¯¢è½¬æ¢ä¸º **Drizzle ORM** æŸ¥è¯¢

è¿™äº›æ­¥éª¤é€‚ç”¨äºæ— è®ºä½ æ˜¯åœ¨å¼€å‘ REST APIï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ Expressã€Koa æˆ– NestJSï¼‰è¿˜æ˜¯ä½¿ç”¨ **TypeORM** è¿›è¡Œæ•°æ®åº“äº¤äº’çš„ä»»ä½•å…¶ä»–ç±»å‹çš„åº”ç”¨ç¨‹åºã€‚

## TypeORM é¡¹ç›®æ¦‚è¿°

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç”¨ `Express` æ„å»ºçš„ REST API ä½œä¸ºç¤ºä¾‹é¡¹ç›®æ¥è¿ç§»åˆ° **Drizzle ORM**ã€‚å®ƒæœ‰å››ä¸ªå®ä½“ï¼š

```typescript collapsable copy filename="src/entities/supplier.entity.ts"
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { Product } from './product.entity';

@Entity({ name: 'suppliers' })
export class Supplier {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'text' })
  public companyName: string;

  @Column({ type: 'text', nullable: true })
  public city: string;

  @Column({ type: 'text' })
  public country: string;

  @OneToMany(() => Product, (product) => product.supplier)
  public products: Product[];
}
```

```typescript collapsable copy filename="src/entities/product.entity.ts"
import { Column, Entity, JoinColumn, ManyToOne, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { OrderDetail } from './order-detail.entity';
import { Supplier } from './supplier.entity';

@Entity({ name: 'products' })
export class Product {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'text' })
  public name: string;

  @Column({ type: 'integer' })
  public supplierId: number;

  @Column({ type: 'decimal', precision: 10, scale: 4 })
  public unitPrice: number;

  @Column({ type: 'integer' })
  public unitsInStock: number;

  @OneToMany(() => OrderDetail, (orderDetail) => orderDetail.product)
  public orderDetails: OrderDetail[];

  @ManyToOne(() => Supplier, (supplier) => supplier.products)
  @JoinColumn({ name: 'supplierId', referencedColumnName: 'id' })
  public supplier: Supplier;
}
```

```typescript collapsable copy filename="src/entities/order.entity.ts"
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { OrderDetail } from './order-detail.entity';

@Entity({ name: 'orders' })
export class Order {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'date' })
  public orderDate: Date;

  @Column({ type: 'date', nullable: true })
  public shippedDate: Date;

  @Column({ type: 'text' })
  public shipAddress: string;

  @Column({ type: 'text', nullable: true })
  public shipPostalCode: string;

  @Column({ type: 'text' })
  public shipCountry: string;

  @OneToMany(() => OrderDetail, (orderDetail) => orderDetail.order)
  public orderDetails: OrderDetail[];
}
```

```typescript collapsable copy filename="src/entities/order-detail.entity.ts"
import { Column, Entity, JoinColumn, ManyToOne, PrimaryColumn } from 'typeorm';
import { Order } from './order.entity';
import { Product } from './product.entity';

@Entity({ name: 'order_details' })
export class OrderDetail {
  @PrimaryColumn({ type: 'integer' })
  public orderId: number;

  @PrimaryColumn({ type: 'integer' })
  public productId: number;

  @Column({ type: 'integer' })
  public quantity: number;

  @ManyToOne(() => Order, (order) => order.orderDetails)
  @JoinColumn({ name: 'orderId', referencedColumnName: 'id' })
  public order: Order;

  @ManyToOne(() => Product, (product) => product.orderDetails)
  @JoinColumn({ name: 'productId', referencedColumnName: 'id' })
  public product: Product;
}
```

è¿™äº›æ¨¡å‹æœ‰ä»¥ä¸‹å…³ç³»ï¼š

1. `Supplier` å’Œ `Product` ä¹‹é—´çš„ `ä¸€å¯¹å¤š` å…³ç³»
2. `Order` å’Œ `Product` ä¹‹é—´çš„ `å¤šå¯¹å¤š` å…³ç³»

å¯¹äº `å¤šå¯¹å¤š` å…³ç³»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¿æ¥è¡¨ `order_details`ï¼Œè¿™æ · `Order` å’Œ `Product` å®ä½“å°†ä¸ `OrderDetail` å®ä½“æœ‰ `ä¸€å¯¹å¤š` å…³ç³»ã€‚

ç›¸åº”çš„è¡¨å·²ç»ä½¿ç”¨ç”Ÿæˆçš„ TypeORM è¿ç§»åˆ›å»ºã€‚

```typescript copy filename="src/db/migrations/1702216840703-init.ts"
import { MigrationInterface, QueryRunner } from "typeorm";

export class Init1702216840703 implements MigrationInterface {
    name = 'Init1702216840703'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`CREATE TABLE "orders" ("id" SERIAL NOT NULL, "orderDate" date NOT NULL, "shippedDate" date, "shipAddress" text NOT NULL, "shipPostalCode" text, "shipCountry" text NOT NULL, CONSTRAINT "PK_710e2d4957aa5878dfe94e4ac2f" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "suppliers" ("id" SERIAL NOT NULL, "companyName" text NOT NULL, "city" text, "country" text NOT NULL, CONSTRAINT "PK_b70ac51766a9e3144f778cfe81e" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "products" ("id" SERIAL NOT NULL, "name" text NOT NULL, "supplierId" integer NOT NULL, "unitPrice" numeric(10,4) NOT NULL, "unitsInStock" integer NOT NULL, CONSTRAINT "PK_0806c755e0aca124e67c0cf6d7d" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "order_details" ("orderId" integer NOT NULL, "productId" integer NOT NULL, "quantity" integer NOT NULL, CONSTRAINT "PK_e08ee153eb9c98ee497c1d1287e" PRIMARY KEY ("orderId", "productId"))`);
        await queryRunner.query(`ALTER TABLE "products" ADD CONSTRAINT "FK_c143cbc0299e1f9220c4b5debd8" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "order_details" ADD CONSTRAINT "FK_147bc15de4304f89a93c7eee969" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "order_details" ADD CONSTRAINT "FK_c67ebaba3e5085b6401911acc70" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`ALTER TABLE "order_details" DROP CONSTRAINT "FK_c67ebaba3e5085b6401911acc70"`);
        await queryRunner.query(`ALTER TABLE "order_details" DROP CONSTRAINT "FK_147bc15de4304f89a93c7eee969"`);
        await queryRunner.query(`ALTER TABLE "products" DROP CONSTRAINT "FK_c143cbc0299e1f9220c4b5debd8"`);
        await queryRunner.query(`DROP TABLE "order_details"`);
        await queryRunner.query(`DROP TABLE "products"`);
        await queryRunner.query(`DROP TABLE "suppliers"`);
        await queryRunner.query(`DROP TABLE "orders"`);
    }

}
```

æœ¬æŒ‡å—ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”‚  â”” ğŸ“œ 1702216840703-init.ts
 â”‚  â”‚  â”” ğŸ“œ typeorm.config.ts
 â”‚  â”œ ğŸ“‚ entities
 â”‚  â”‚  â”œ ğŸ“œ order-detail.entity.ts
 â”‚  â”‚  â”œ ğŸ“œ order.entity.ts
 â”‚  â”‚  â”œ ğŸ“œ product.entity.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.entity.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### å®‰è£… Drizzle ORM & Drizzle Kit

ç¬¬ä¸€æ­¥æ˜¯å®‰è£… **Drizzle ORM** å’Œ `pg` åŒ…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä½œä¸ºé©±åŠ¨ç¨‹åºã€‚ç¬¬äºŒæ­¥æ˜¯å®‰è£… **Drizzle Kit** å’Œ `pg` çš„ç±»å‹å®šä¹‰ã€‚[Drizzle Kit](/docs/kit-overview) - ç”¨äºè‡ªåŠ¨ç”Ÿæˆ SQL è¿ç§»å’Œå¿«é€ŸåŸå‹è®¾è®¡çš„ CLI å·¥å…·ã€‚

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### è®¾ç½® Drizzle config æ–‡ä»¶

**Drizzle config** - ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”± **Drizzle Kit** ä½¿ç”¨ï¼ŒåŒ…å«äº†æ‰€æœ‰å…³äºä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„ä¿¡æ¯ã€‚

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // ç¡®ä¿å®‰è£… dotenv åŒ…
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  out: './src/drizzle',
  schema: './src/drizzle/schema.ts',
  dbCredentials: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT!),
    user: process.env.DB_USERNAME!,
    password: process.env.DB_PASSWORD!,
    database: process.env.DB_NAME!,
  },
  // æ‰“å°æ‰€æœ‰è¯­å¥
  verbose: true,
  // æ€»æ˜¯è¯·æ±‚ç¡®è®¤
  strict: true,
});
```


##### æ›¿æ¢æŸ¥è¯¢è¯­å¥

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€‰æ‹©ä¸€è¡Œã€å¤šè¡Œã€è®¡æ•°è¡Œã€è¿‡æ»¤è¡Œã€è¿æ¥è¡¨å’Œåˆ†é¡µç»“æœã€‚

1. `GET /products/:id`

åœ¨ **TypeORM** ä¸­ï¼Œå“åº”ç±»å‹ä¸æ˜¯ä¸¥æ ¼ç±»å‹çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ é€‰æ‹©åŒ…å«ä¸€ä¸ªå…³ç³»æˆ–åªé€‰æ‹©å‡ ä¸ªå­—æ®µè€Œä¸æ˜¯å…¨éƒ¨ï¼Œè¿™äº›ä¿®æ”¹ä¸ä¼šåæ˜ åœ¨å“åº”ç±»å‹ä¸­ã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import dataSource from '../db/typeorm.config';
import { Product } from '../entities/product.entity';

const { id } = req.params;

const repository = dataSource.getRepository(Product);

const response = await repostitory.findOne({
  where: { id },
  relations: ['supplier'],
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œå“åº”ç±»å‹å°†ç²¾ç¡®åŒ¹é…åœ¨ select å¯¹è±¡ä¸­æŒ‡å®šçš„å†…å®¹ï¼Œæ‰€ä»¥åŒ…å« `supplier` å…³ç³»æ˜¯å®Œå…¨ç±»å‹å®‰å…¨çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

åœ¨ **TypeORM** ä¸­ï¼Œç»“æœä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æŒ‡å®šä½ æƒ³è¦é€‰æ‹©çš„å­—æ®µã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import { ILike } from 'typeorm';
import dataSource from '../db/typeorm.config';
import { Product } from '../entities/product.entity';

const repository = dataSource.getRepository(Product);

const response = await repostitory.findAndCount({
  skip: 0,
  take: 10,
  where: {
    name: ILike(`%test%`),
  },
  select: ['id', 'name', 'unitPrice', 'unitsInStock'],
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœæ˜¯ä¸¥æ ¼ç±»å‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€ä½ é€‰æ‹©çš„å­—æ®µè¢«æ˜ç¡®å®šä¹‰ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

åœ¨ **TypeORM** ä¸­ï¼Œä½ ä¸èƒ½åœ¨ä½¿ç”¨ `èšåˆå‡½æ•°` çš„åŒæ—¶ä½¿ç”¨å…³ç³»å’Œä½¿ç”¨ `findOne` æ–¹æ³•é€‰æ‹©ç‰¹å®šå­—æ®µã€‚æ‰€ä»¥ï¼Œä½ å¿…é¡»ä½¿ç”¨ `querybuilder`ï¼Œè¿™ä¹Ÿä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚

æˆ‘ä»¬æƒ³è¦ä» `orders` è¡¨ä¸­é€‰æ‹© `id`ã€`orderDate` å’Œ `shipCountry` å­—æ®µï¼Œå¹¶ä½¿ç”¨ `èšåˆå‡½æ•°` è®¡ç®—è®¢å•çš„ `totalPrice`ã€è®¢å•ä¸­äº§å“çš„ `totalQuantity` å’Œè®¢å•ä¸­çš„ `totalProducts`ã€‚

```typescript copy filename="src/controllers/order.controller.ts"
import dataSource from '../db/typeorm.config';
import { Order } from '../entities/order.entity';

const { id } = req.params;

const orderRepository = dataSource.getRepository(Order);

const orderQueryBuilder = orderRepository.createQueryBuilder('order');

const response = await orderQueryBuilder
  .select([
    'order.id as id',
    'order.orderDate as "orderDate"',
    'order.shipCountry as "shipCountry"',
    'SUM(product.unitPrice * detail.quantity)::float as "totalPrice"',
    'SUM(detail.quantity)::int as "totalQuantity"',
    'COUNT(detail.productId)::int as "totalProducts"',
  ])
  .leftJoin('order.orderDetails', 'detail')
  .leftJoin('detail.product', 'product')
  .groupBy('order.id')
  .where('order.id = :id', { id })
  .getRawOne();
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql<number>`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql<number>`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql<number>`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœåœ¨èšåˆæ—¶ä¹Ÿæ˜¯ç±»å‹å®‰å…¨çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**æ³¨æ„ï¼š** ç›®å‰å…³ç³»æŸ¥è¯¢ä¸æ”¯æŒèšåˆï¼Œæ‰€ä»¥ä½ å¿…é¡»ä½¿ç”¨ `æ ¸å¿ƒæŸ¥è¯¢`ã€‚

##### æ›¿æ¢æ›´æ–°æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ›´æ–°å¤šè¡Œã€‚

1. `PATCH /suppliers/:id`

```typescript copy filename="src/controllers/supplier.controller.ts"
import dataSource from '../db/typeorm.config';
import { Supplier } from '../entities/supplier.entity';

const { id } = req.params;

const repository = dataSource.getRepository(Supplier);

const supplier = await repository.findOneBy({ id });
if (!supplier) {
  throw new Error('Supplier not found');
}

supplier.city = 'TestCity1Updated';
supplier.country = 'TestCountry1Updated';

await repository.save(supplier);
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```

##### æ›¿æ¢åˆ é™¤æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨äº‹åŠ¡åˆ é™¤å•è¡Œå’Œå¤šè¡Œã€‚

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import dataSource from '../db/typeorm.config';
import { OrderDetail } from '../entities/order-detail.entity';
import { Order } from '../entities/order.entity';

const { id } = req.params;

const queryRunner = dataSource.createQueryRunner();

await queryRunner.connect();

await queryRunner.startTransaction();

try {
  await queryRunner.manager.delete(OrderDetail, { orderId: id });

  await queryRunner.manager.delete(Order, { id });

  await queryRunner.commitTransaction();
} catch (e) {
  await queryRunner.rollbackTransaction();

  console.error(e);
} finally {
  await queryRunner.release();
}
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```

</Steps>
