---
title: "Drizzle ä¸ Nile æ•°æ®åº“é›†æˆ"
date: "2025-01-15"
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•å°† Drizzle ORM ä¸ [Nile Database](https://thenile.dev) é›†æˆä½¿ç”¨ã€‚Nile æ˜¯ä¸ºå¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºé‡æ–°è®¾è®¡çš„ Postgresã€‚

æœ¬æ•™ç¨‹å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ä¸ Nile çš„è™šæ‹Ÿç§Ÿæˆ·æ•°æ®åº“æ¥å¼€å‘ä¸€ä¸ªå®‰å…¨ã€å¯æ‰©å±•çš„å¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬å°†ä¸€æ­¥æ­¥æ„å»ºè¿™ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨æƒ³é¢„è§ˆå®Œæ•´ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹å…¶ [Github ä»“åº“](https://github.com/niledatabase/niledatabase/tree/main/examples/quickstart/drizzle)ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨éœ€è¦å®‰è£… `dotenv` åŒ…æ¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚åœ¨[è¿™é‡Œ](https://www.npmjs.com/package/dotenv)äº†è§£æ›´å¤šå…³äºè¿™ä¸ªåŒ…çš„ä¿¡æ¯
<Npm>
  dotenv
</Npm>
- æ‚¨éœ€è¦å®‰è£… `node-postgres` åŒ…æ¥è¿æ¥ Postgres æ•°æ®åº“ã€‚åœ¨[è¿™é‡Œ](https://www.npmjs.com/package/node-postgres)äº†è§£æ›´å¤šå…³äºè¿™ä¸ªåŒ…çš„ä¿¡æ¯
<Npm>
  node-postgres
</Npm>
- æ‚¨éœ€è¦å®‰è£… `express` åŒ…ä½œä¸º Web æ¡†æ¶ã€‚åœ¨[è¿™é‡Œ](https://expressjs.com/)äº†è§£æ›´å¤šå…³äº express çš„ä¿¡æ¯
<Npm>
  express
</Npm>

- æœ¬æŒ‡å—ä½¿ç”¨ [AsyncLocalStorage](https://nodejs.org/api/async_context.html) æ¥ç®¡ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ‚¨çš„æ¡†æ¶æˆ–è¿è¡Œæ—¶ä¸æ”¯æŒ `AsyncLocalStorage`ï¼Œæ‚¨å¯ä»¥å‚è€ƒ [Drizzle<>Nile</>](../connect-nile) æ–‡æ¡£äº†è§£å…¶ä»–é€‰é¡¹ã€‚
</Prerequisites>

## è®¾ç½® Nile å’Œ Drizzle ORM

<Steps>
#### æ³¨å†Œ Nile å¹¶åˆ›å»ºæ•°æ®åº“

å¦‚æœæ‚¨è¿˜æ²¡æœ‰æ³¨å†Œï¼Œè¯·æ³¨å†Œ [Nile](https://console.thenile.dev) å¹¶æŒ‰ç…§åº”ç”¨ç¨‹åºè¯´æ˜åˆ›å»ºæ–°æ•°æ®åº“ã€‚

#### è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

åœ¨å·¦ä¾§èœå•æ ä¸­ï¼Œé€‰æ‹©"Settings"é€‰é¡¹ï¼Œç‚¹å‡» Postgres å›¾æ ‡ï¼Œç„¶åç‚¹å‡»"generate credentials"ã€‚å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²å¹¶å°†å…¶æ·»åŠ åˆ°é¡¹ç›®çš„ `.env` æ–‡ä»¶ä¸­ï¼š

```plaintext copy
NILEDB_URL=postgres://youruser:yourpassword@us-west-2.db.thenile.dev:5432:5432/your_db_name
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import dotenv from "dotenv/config";
import { sql } from "drizzle-orm";
import { AsyncLocalStorage } from "async_hooks";

export const db = drizzle(process.env.NILEDB_URL);
export const tenantContext = new AsyncLocalStorage<string | undefined>();

export function tenantDB<T>(cb: (tx: any) => T | Promise<T>): Promise<T> {
  return db.transaction(async (tx) => {
    const tenantId = tenantContext.getStore();
    console.log("executing query with tenant: " + tenantId);
    // å¦‚æœæœ‰ç§Ÿæˆ· IDï¼Œå°†å…¶è®¾ç½®åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­
    if (tenantId) {
      await tx.execute(sql`set local nile.tenant_id = '${sql.raw(tenantId)}'`);
    }

    return cb(tx);
  }) as Promise<T>;
}
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨ï¼ŒåŒ…å«äº†æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';
export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.NILEDB_URL!,
  },
});
```

#### æ£€æŸ¥ Nile æ•°æ®åº“

Nile æ•°æ®åº“æœ‰ä¸€äº›å†…ç½®è¡¨ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯ `tenants` è¡¨ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†ç§Ÿæˆ·ã€‚
ä¸ºäº†ä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¿™ä¸ªè¡¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle Kit CLI ç”Ÿæˆä¸€ä¸ªåŒ…å«æ­¤æ¶æ„çš„æ¶æ„æ–‡ä»¶ã€‚

```bash copy
npx drizzle-kit pull
```

æ£€æŸ¥çš„ç»“æœå°†æ˜¯ä¸€ä¸ª `schema.ts` æ–‡ä»¶ã€ç”¨äºå­˜å‚¨æ•°æ®åº“æ¶æ„å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€å¸¦æœ‰è¿ç§»çš„ sql æ–‡ä»¶ä»¥åŠç”¨äº[å…³ç³»æŸ¥è¯¢](/docs/rqb)çš„ `relations.ts` æ–‡ä»¶ã€‚

<TransferCode/>

ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ `schema.ts` æ–‡ä»¶ç¤ºä¾‹ï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡æ£€æŸ¥ç”Ÿæˆçš„è¡¨æ¶æ„
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});
```

#### åˆ›å»ºé¢å¤–çš„è¡¨

é™¤äº†å†…ç½®è¡¨å¤–ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜éœ€è¦ä¸€äº›è¡¨æ¥å­˜å‚¨å…¶æ•°æ®ã€‚æˆ‘ä»¬å°†æŠŠå®ƒä»¬æ·»åŠ åˆ°ä¹‹å‰ç”Ÿæˆçš„ `src/db/schema.ts` ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶å°†çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡æ£€æŸ¥ç”Ÿæˆçš„è¡¨æ¶æ„
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
});
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### åˆå§‹åŒ– Web åº”ç”¨ç¨‹åº

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®äº† Drizzle æ¥è¿æ¥ Nile å¹¶ä¸”æœ‰äº†æˆ‘ä»¬çš„æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤šç§Ÿæˆ· Web åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬ã€‚
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Express ä½œä¸º Web æ¡†æ¶ï¼Œå°½ç®¡ Nile å’Œ Drizzle å¯ä»¥ä»ä»»ä½• Web æ¡†æ¶ä¸­ä½¿ç”¨ã€‚

ä¸ºäº†ä¿æŒç¤ºä¾‹ç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨å•ä¸ªæ–‡ä»¶ - `src/app.ts` ä¸­å®ç° Web åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å°†ä»åˆå§‹åŒ– Web åº”ç”¨ç¨‹åºå¼€å§‹ï¼š

```typescript copy filename="src/app.ts"
import express from "express";
import { tenantDB, tenantContext, db } from "./db/db";
import {
  tenants as tenantSchema,
  todos as todoSchema,
} from "./db/schema";
import { eq } from "drizzle-orm";

const PORT = process.env.PORT || 3001;

const app = express();
app.listen(PORT, () => console.log(`Server is running on port ${PORT}`));
app.use(express.json());
```

#### åˆå§‹åŒ–ç§Ÿæˆ·æ„ŸçŸ¥ä¸­é—´ä»¶

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘ç¤ºä¾‹æ·»åŠ ä¸­é—´ä»¶ã€‚è¿™ä¸ªä¸­é—´ä»¶ä»è·¯å¾„å‚æ•°ä¸­è·å–ç§Ÿæˆ· ID å¹¶å°†å…¶å­˜å‚¨åœ¨ `AsyncLocalStorage` ä¸­ã€‚
æˆ‘ä»¬åœ¨ `src/db/index.ts` ä¸­åˆ›å»ºçš„ `tenantDB` åŒ…è£…å™¨ä½¿ç”¨è¿™ä¸ªç§Ÿæˆ· ID åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è®¾ç½® `nile.tenant_id`ï¼Œ
è¿™æ ·å°±ä¿è¯äº†æŸ¥è¯¢å°†åœ¨è¿™ä¸ªç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“ä¸Šæ‰§è¡Œã€‚

```typescript copy filename="src/app.ts"
// æ ¹æ® URL å‚æ•°åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç§Ÿæˆ· ID
app.use('/api/tenants/:tenantId/*', (req, res, next) => {
  const tenantId = req.params.tenantId;
  console.log("setting context to tenant: " + tenantId);
  tenantContext.run(tenantId, next);
});
```

<Callout>
ç¤ºä¾‹ä»è·¯å¾„å‚æ•°ä¸­è·å–ç§Ÿæˆ· IDï¼Œä½†é€šå¸¸ä¹Ÿå¯ä»¥åœ¨ `x-tenant-id` ç­‰å¤´éƒ¨æˆ– cookie ä¸­è®¾ç½®ç§Ÿæˆ· IDã€‚
</Callout>

#### æ·»åŠ è·¯ç”±

æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›ç”¨äºåˆ›å»ºå’Œåˆ—å‡ºç§Ÿæˆ·å’Œå¾…åŠäº‹é¡¹çš„è·¯ç”±ã€‚æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ `tenantDB` åŒ…è£…å™¨æ¥è¿æ¥åˆ°ç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“ã€‚
åŒæ—¶æ³¨æ„åœ¨ `app.get("/api/tenants/:tenantId/todos"` ä¸­æˆ‘ä»¬ä¸éœ€è¦åœ¨æŸ¥è¯¢ä¸­æŒ‡å®š `where tenant_id=...`ã€‚
è¿™æ­£æ˜¯å› ä¸ºæˆ‘ä»¬è¢«è·¯ç”±åˆ°äº†è¯¥ç§Ÿæˆ·çš„æ•°æ®åº“ï¼ŒæŸ¥è¯¢ä¸èƒ½è¿”å›ä»»ä½•å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®ã€‚

```typescript copy filename="src/app.ts" {6,20,39,58,62,75,83}
// åˆ›å»ºæ–°ç§Ÿæˆ·
app.post("/api/tenants", async (req, res) => {
  try {
    const name = req.body.name;
    var tenants: any = null;
    tenants = await tenantDB(async (tx) => {
        return await tx.insert(tenantSchema).values({ name }).returning();
    });
    res.json(tenants);
  } catch (error: any) {
    console.log("error creating tenant: " + error.message);
    res.status(500).json({message: "Internal Server Error",});
  }
});

// è¿”å›ç§Ÿæˆ·åˆ—è¡¨
app.get("/api/tenants", async (req, res) => {
  let tenants: any = [];
  try {
      tenants = await tenantDB(async (tx) => {
        return await tx.select().from(tenantSchema);
      });
    res.json(tenants);
  } catch (error: any) {
    console.log("error listing tenants: " + error.message);
    res.status(500).json({message: "Internal Server Error",});
  }
});

// ä¸ºç§Ÿæˆ·æ·»åŠ æ–°ä»»åŠ¡
app.post("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { title, complete } = req.body;
    if (!title) {
      res.status(400).json({message: "No task title provided",});
    }
    const tenantId = req.params.tenantId;

    const newTodo = await tenantDB(async (tx) => {
      return await tx
        .insert(todoSchema)
        .values({ tenantId, title, complete })
        .returning();
    });
    // è¿”å›æ—¶ä¸åŒ…å«åµŒå…¥å‘é‡ï¼Œå› ä¸ºå®ƒå¾ˆå¤§ä¸”æ— ç”¨
    res.json(newTodo);
  } catch (error: any) {
    console.log("error adding task: " + error.message);
    res.status(500).json({message: "Internal Server Error",});
  }
});

// æ›´æ–°ç§Ÿæˆ·çš„ä»»åŠ¡
// ä¸éœ€è¦ where å­å¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­æœ‰ç§Ÿæˆ·
app.put("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { id, complete } = req.body;
    await tenantDB(async (tx) => {
      return await tx
        .update(todoSchema)
        .set({ complete })
        .where(eq(todoSchema.id, id));
    });
    res.sendStatus(200);
  } catch (error: any) {
    console.log("error updating tasks: " + error.message);
    res.status(500).json({message: "Internal Server Error",});
  }
});

// è·å–ç§Ÿæˆ·çš„æ‰€æœ‰ä»»åŠ¡
app.get("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    // è¿™é‡Œä¸éœ€è¦ "where" å­å¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®äº†ç§Ÿæˆ· ID
    const todos = await tenantDB(async (tx) => {
      return await tx
        .select({
          id: todoSchema.id,
          tenant_id: todoSchema.tenantId,
          title: todoSchema.title,
          estimate: todoSchema.estimate,
        })
        .from(todoSchema);
    });
    res.json(todos);
  } catch (error: any) {
    console.log("error listing tasks: " + error.message);
    res.status(500).json({message: error.message,});
  }
});
```

#### è¯•ä¸€è¯•ï¼

ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œæ‚¨çš„æ–° Web åº”ç”¨ç¨‹åºï¼š

```bash copy
npx tsx src/app.ts
```

å¹¶ä½¿ç”¨ `curl` æ¥å°è¯•æ‚¨åˆšåˆšåˆ›å»ºçš„è·¯ç”±ï¼š

```bash
# åˆ›å»ºç§Ÿæˆ·
curl --location --request POST 'localhost:3001/api/tenants' \
--header 'Content-Type: application/json' \
--data-raw '{"name":"my first customer"}'

# è·å–ç§Ÿæˆ·åˆ—è¡¨
curl  -X GET 'http://localhost:3001/api/tenants'

# åˆ›å»ºå¾…åŠäº‹é¡¹ï¼ˆåˆ«å¿˜äº†åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X POST \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos' \
  --header 'Content-Type: application/json' \
  --data-raw '{"title": "feed the cat", "complete": false}'

# åˆ—å‡ºç§Ÿæˆ·çš„å¾…åŠäº‹é¡¹ï¼ˆåˆ«å¿˜äº†åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X GET \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos'
```
</Steps>

## é¡¹ç›®æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰æ•°æ®åº“ç›¸å…³æ–‡ä»¶ï¼ŒåŒ…æ‹¬ `db.ts` ä¸­çš„è¿æ¥é…ç½®å’Œ `schema.ts` ä¸­çš„æ¶æ„å®šä¹‰ã€‚
è¿ç§»å’Œæ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶åœ¨ `./drizzle` ä¸­

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ db.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ app.ts
 â”œ ğŸ“‚ drizzle
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”œ ğŸ“œ relations.ts
 â”‚   â”œ ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```
